{"version":3,"sources":["../../src/handshakes/ik.ts"],"names":["Buffer","generateKeypair","isValidPublicKey","AbstractHandshake","IK","initSession","initiator","prologue","s","rs","psk","createEmptyKey","hs","initializeInitiator","initializeResponder","i","mc","sendMessage","session","message","messageBuffer","writeMessageA","mb","h","cs1","cs2","writeMessageB","Error","writeMessageRegular","recvMessage","plaintext","alloc","valid","readMessageA","pt","v","readMessageB","payload","e","ne","publicKey","mixHash","ss","mixKey","dh","privateKey","spk","from","ns","encryptAndHash","ciphertext","re","split","valid1","decryptAndHash","length","valid2","name","initializeSymmetric"],"mappings":"AAAA,SAAQA,MAAR,QAAqB,QAArB;AAGA,SAAQC,eAAR,EAAyBC,gBAAzB,QAAgD,UAAhD;AACA,SAAQC,iBAAR,QAAgC,sBAAhC;AAIA,OAAO,MAAMC,EAAN,SAAiBD,iBAAjB,CAAmC;AACjCE,EAAAA,WAAP,CAAmBC,SAAnB,EAAuCC,QAAvC,EAA0DC,CAA1D,EAAsEC,EAAtE,EAAiG;AAC/F,UAAMC,GAAG,GAAG,KAAKC,cAAL,EAAZ;AAEA,QAAIC,EAAJ;;AACA,QAAIN,SAAJ,EAAe;AACbM,MAAAA,EAAE,GAAG,KAAKC,mBAAL,CAAyBN,QAAzB,EAAmCC,CAAnC,EAAsCC,EAAtC,EAA0CC,GAA1C,CAAL;AACD,KAFD,MAEO;AACLE,MAAAA,EAAE,GAAG,KAAKE,mBAAL,CAAyBP,QAAzB,EAAmCC,CAAnC,EAAsCC,EAAtC,EAA0CC,GAA1C,CAAL;AACD;;AAED,WAAO;AACLE,MAAAA,EADK;AAELG,MAAAA,CAAC,EAAET,SAFE;AAGLU,MAAAA,EAAE,EAAE;AAHC,KAAP;AAKD;;AAEMC,EAAAA,WAAP,CAAmBC,OAAnB,EAA0CC,OAA1C,EAAyE;AACvE,QAAIC,aAAJ;;AACA,QAAIF,OAAO,CAACF,EAAR,KAAe,CAAnB,EAAsB;AACpBI,MAAAA,aAAa,GAAG,KAAKC,aAAL,CAAmBH,OAAO,CAACN,EAA3B,EAA+BO,OAA/B,CAAhB;AACD,KAFD,MAEO,IAAID,OAAO,CAACF,EAAR,KAAe,CAAnB,EAAsB;AAC3B,YAAM;AAAEI,QAAAA,aAAa,EAAEE,EAAjB;AAAqBC,QAAAA,CAArB;AAAwBC,QAAAA,GAAxB;AAA6BC,QAAAA;AAA7B,UAAqC,KAAKC,aAAL,CAAmBR,OAAO,CAACN,EAA3B,EAA+BO,OAA/B,CAA3C;AACAC,MAAAA,aAAa,GAAGE,EAAhB;AACAJ,MAAAA,OAAO,CAACK,CAAR,GAAYA,CAAZ;AACAL,MAAAA,OAAO,CAACM,GAAR,GAAcA,GAAd;AACAN,MAAAA,OAAO,CAACO,GAAR,GAAcA,GAAd;AACD,KANM,MAMA,IAAIP,OAAO,CAACF,EAAR,GAAa,CAAjB,EAAoB;AACzB,UAAIE,OAAO,CAACH,CAAZ,EAAe;AACb,YAAI,CAACG,OAAO,CAACM,GAAb,EAAkB;AAChB,gBAAM,IAAIG,KAAJ,CAAU,mCAAV,CAAN;AACD;;AAEDP,QAAAA,aAAa,GAAG,KAAKQ,mBAAL,CAAyBV,OAAO,CAACM,GAAjC,EAAsCL,OAAtC,CAAhB;AACD,OAND,MAMO;AACL,YAAI,CAACD,OAAO,CAACO,GAAb,EAAkB;AAChB,gBAAM,IAAIE,KAAJ,CAAU,mCAAV,CAAN;AACD;;AAEDP,QAAAA,aAAa,GAAG,KAAKQ,mBAAL,CAAyBV,OAAO,CAACO,GAAjC,EAAsCN,OAAtC,CAAhB;AACD;AACF,KAdM,MAcA;AACL,YAAM,IAAIQ,KAAJ,CAAU,kBAAV,CAAN;AACD;;AAEDT,IAAAA,OAAO,CAACF,EAAR;AACA,WAAOI,aAAP;AACD;;AAEMS,EAAAA,WAAP,CAAmBX,OAAnB,EAA0CC,OAA1C,EAAsG;AACpG,QAAIW,SAAS,GAAG9B,MAAM,CAAC+B,KAAP,CAAa,CAAb,CAAhB;AAAA,QAAiCC,KAAK,GAAG,KAAzC;;AACA,QAAId,OAAO,CAACF,EAAR,KAAe,CAAnB,EAAsB;AACpB,OAAC;AAACc,QAAAA,SAAD;AAAYE,QAAAA;AAAZ,UAAqB,KAAKC,YAAL,CAAkBf,OAAO,CAACN,EAA1B,EAA8BO,OAA9B,CAAtB;AACD;;AACD,QAAID,OAAO,CAACF,EAAR,KAAe,CAAnB,EAAsB;AACpB,YAAM;AAAEc,QAAAA,SAAS,EAAEI,EAAb;AAAiBF,QAAAA,KAAK,EAAEG,CAAxB;AAA2BZ,QAAAA,CAA3B;AAA8BC,QAAAA,GAA9B;AAAmCC,QAAAA;AAAnC,UAA2C,KAAKW,YAAL,CAAkBlB,OAAO,CAACN,EAA1B,EAA8BO,OAA9B,CAAjD;AACAW,MAAAA,SAAS,GAAGI,EAAZ;AACAF,MAAAA,KAAK,GAAGG,CAAR;AACAjB,MAAAA,OAAO,CAACK,CAAR,GAAYA,CAAZ;AACAL,MAAAA,OAAO,CAACM,GAAR,GAAcA,GAAd;AACAN,MAAAA,OAAO,CAACO,GAAR,GAAcA,GAAd;AACD;;AACDP,IAAAA,OAAO,CAACF,EAAR;AACA,WAAO;AAACc,MAAAA,SAAD;AAAYE,MAAAA;AAAZ,KAAP;AACD;;AAEOX,EAAAA,aAAR,CAAsBT,EAAtB,EAA0CyB,OAA1C,EAAyE;AACvEzB,IAAAA,EAAE,CAAC0B,CAAH,GAAOrC,eAAe,EAAtB;AACA,UAAMsC,EAAE,GAAG3B,EAAE,CAAC0B,CAAH,CAAKE,SAAhB;AACA,SAAKC,OAAL,CAAa7B,EAAE,CAAC8B,EAAhB,EAAoBH,EAApB;AACA,SAAKI,MAAL,CAAY/B,EAAE,CAAC8B,EAAf,EAAmB,KAAKE,EAAL,CAAQhC,EAAE,CAAC0B,CAAH,CAAKO,UAAb,EAAyBjC,EAAE,CAACH,EAA5B,CAAnB;AACA,UAAMqC,GAAG,GAAG9C,MAAM,CAAC+C,IAAP,CAAYnC,EAAE,CAACJ,CAAH,CAAKgC,SAAjB,CAAZ;AACA,UAAMQ,EAAE,GAAG,KAAKC,cAAL,CAAoBrC,EAAE,CAAC8B,EAAvB,EAA2BI,GAA3B,CAAX;AAEA,SAAKH,MAAL,CAAY/B,EAAE,CAAC8B,EAAf,EAAmB,KAAKE,EAAL,CAAQhC,EAAE,CAACJ,CAAH,CAAKqC,UAAb,EAAyBjC,EAAE,CAACH,EAA5B,CAAnB;AACA,UAAMyC,UAAU,GAAG,KAAKD,cAAL,CAAoBrC,EAAE,CAAC8B,EAAvB,EAA2BL,OAA3B,CAAnB;AAEA,WAAO;AAAEE,MAAAA,EAAF;AAAMS,MAAAA,EAAN;AAAUE,MAAAA;AAAV,KAAP;AACD;;AAEOxB,EAAAA,aAAR,CAAsBd,EAAtB,EAA0CyB,OAA1C,EAA0D;AACxDzB,IAAAA,EAAE,CAAC0B,CAAH,GAAOrC,eAAe,EAAtB;AACA,UAAMsC,EAAE,GAAG3B,EAAE,CAAC0B,CAAH,CAAKE,SAAhB;AACA,SAAKC,OAAL,CAAa7B,EAAE,CAAC8B,EAAhB,EAAoBH,EAApB;AAEA,SAAKI,MAAL,CAAY/B,EAAE,CAAC8B,EAAf,EAAmB,KAAKE,EAAL,CAAQhC,EAAE,CAAC0B,CAAH,CAAKO,UAAb,EAAyBjC,EAAE,CAACuC,EAA5B,CAAnB;AACA,SAAKR,MAAL,CAAY/B,EAAE,CAAC8B,EAAf,EAAmB,KAAKE,EAAL,CAAQhC,EAAE,CAAC0B,CAAH,CAAKO,UAAb,EAAyBjC,EAAE,CAACH,EAA5B,CAAnB;AACA,UAAMyC,UAAU,GAAG,KAAKD,cAAL,CAAoBrC,EAAE,CAAC8B,EAAvB,EAA2BL,OAA3B,CAAnB;AACA,UAAMW,EAAE,GAAG,KAAKrC,cAAL,EAAX;AACA,UAAMS,aAA4B,GAAG;AAACmB,MAAAA,EAAD;AAAKS,MAAAA,EAAL;AAASE,MAAAA;AAAT,KAArC;AACA,UAAM;AAAE1B,MAAAA,GAAF;AAAOC,MAAAA;AAAP,QAAe,KAAK2B,KAAL,CAAWxC,EAAE,CAAC8B,EAAd,CAArB;AAEA,WAAO;AAAEtB,MAAAA,aAAF;AAAiBI,MAAAA,GAAjB;AAAsBC,MAAAA,GAAtB;AAA2BF,MAAAA,CAAC,EAAEX,EAAE,CAAC8B,EAAH,CAAMnB;AAApC,KAAP;AACD;;AAEOU,EAAAA,YAAR,CAAqBrB,EAArB,EAAyCO,OAAzC,EAAqG;AACnG,QAAIjB,gBAAgB,CAACiB,OAAO,CAACoB,EAAT,CAApB,EAAkC;AAChC3B,MAAAA,EAAE,CAACuC,EAAH,GAAQhC,OAAO,CAACoB,EAAhB;AACD;;AAED,SAAKE,OAAL,CAAa7B,EAAE,CAAC8B,EAAhB,EAAoB9B,EAAE,CAACuC,EAAvB;AACA,SAAKR,MAAL,CAAY/B,EAAE,CAAC8B,EAAf,EAAmB,KAAKE,EAAL,CAAQhC,EAAE,CAACJ,CAAH,CAAKqC,UAAb,EAAyBjC,EAAE,CAACuC,EAA5B,CAAnB;AACA,UAAM;AAACrB,MAAAA,SAAS,EAAEkB,EAAZ;AAAgBhB,MAAAA,KAAK,EAAEqB;AAAvB,QAAiC,KAAKC,cAAL,CAAoB1C,EAAE,CAAC8B,EAAvB,EAA2BvB,OAAO,CAAC6B,EAAnC,CAAvC;;AACA,QAAIK,MAAM,IAAIL,EAAE,CAACO,MAAH,KAAc,EAAxB,IAA8BrD,gBAAgB,CAAC8C,EAAD,CAAlD,EAAwD;AACtDpC,MAAAA,EAAE,CAACH,EAAH,GAAQuC,EAAR;AACD;;AACD,SAAKL,MAAL,CAAY/B,EAAE,CAAC8B,EAAf,EAAmB,KAAKE,EAAL,CAAQhC,EAAE,CAACJ,CAAH,CAAKqC,UAAb,EAAyBjC,EAAE,CAACH,EAA5B,CAAnB;AACA,UAAM;AAACqB,MAAAA,SAAD;AAAYE,MAAAA,KAAK,EAAEwB;AAAnB,QAA6B,KAAKF,cAAL,CAAoB1C,EAAE,CAAC8B,EAAvB,EAA2BvB,OAAO,CAAC+B,UAAnC,CAAnC;AACA,WAAO;AAACpB,MAAAA,SAAD;AAAYE,MAAAA,KAAK,EAAGqB,MAAM,IAAIG;AAA9B,KAAP;AACD;;AAEOpB,EAAAA,YAAR,CAAqBxB,EAArB,EAAyCO,OAAzC,EAAmJ;AACjJ,QAAIjB,gBAAgB,CAACiB,OAAO,CAACoB,EAAT,CAApB,EAAkC;AAChC3B,MAAAA,EAAE,CAACuC,EAAH,GAAQhC,OAAO,CAACoB,EAAhB;AACD;;AAED,SAAKE,OAAL,CAAa7B,EAAE,CAAC8B,EAAhB,EAAoB9B,EAAE,CAACuC,EAAvB;;AACA,QAAI,CAACvC,EAAE,CAAC0B,CAAR,EAAW;AACT,YAAM,IAAIX,KAAJ,CAAU,sDAAV,CAAN;AACD;;AACD,SAAKgB,MAAL,CAAY/B,EAAE,CAAC8B,EAAf,EAAmB,KAAKE,EAAL,CAAQhC,EAAE,CAAC0B,CAAH,CAAKO,UAAb,EAAyBjC,EAAE,CAACuC,EAA5B,CAAnB;AACA,SAAKR,MAAL,CAAY/B,EAAE,CAAC8B,EAAf,EAAmB,KAAKE,EAAL,CAAQhC,EAAE,CAACJ,CAAH,CAAKqC,UAAb,EAAyBjC,EAAE,CAACuC,EAA5B,CAAnB;AACA,UAAM;AAACrB,MAAAA,SAAD;AAAYE,MAAAA;AAAZ,QAAqB,KAAKsB,cAAL,CAAoB1C,EAAE,CAAC8B,EAAvB,EAA2BvB,OAAO,CAAC+B,UAAnC,CAA3B;AACA,UAAM;AAAE1B,MAAAA,GAAF;AAAOC,MAAAA;AAAP,QAAe,KAAK2B,KAAL,CAAWxC,EAAE,CAAC8B,EAAd,CAArB;AAEA,WAAO;AAAEnB,MAAAA,CAAC,EAAEX,EAAE,CAAC8B,EAAH,CAAMnB,CAAX;AAAcS,MAAAA,KAAd;AAAqBF,MAAAA,SAArB;AAAgCN,MAAAA,GAAhC;AAAqCC,MAAAA;AAArC,KAAP;AACD;;AAEOZ,EAAAA,mBAAR,CAA4BN,QAA5B,EAA+CC,CAA/C,EAA2DC,EAA3D,EAAwEC,GAAxE,EAAsG;AACpG,UAAM+C,IAAI,GAAG,kCAAb;AACA,UAAMf,EAAE,GAAG,KAAKgB,mBAAL,CAAyBD,IAAzB,CAAX;AACA,SAAKhB,OAAL,CAAaC,EAAb,EAAiBnC,QAAjB;AACA,SAAKkC,OAAL,CAAaC,EAAb,EAAiBjC,EAAjB;AACA,UAAM0C,EAAE,GAAGnD,MAAM,CAAC+B,KAAP,CAAa,EAAb,CAAX;AAEA,WAAO;AAAEW,MAAAA,EAAF;AAAMlC,MAAAA,CAAN;AAASC,MAAAA,EAAT;AAAa0C,MAAAA,EAAb;AAAiBzC,MAAAA;AAAjB,KAAP;AACD;;AAEOI,EAAAA,mBAAR,CAA4BP,QAA5B,EAA+CC,CAA/C,EAA2DC,EAA3D,EAAwEC,GAAxE,EAAsG;AACpG,UAAM+C,IAAI,GAAG,kCAAb;AACA,UAAMf,EAAE,GAAG,KAAKgB,mBAAL,CAAyBD,IAAzB,CAAX;AACA,SAAKhB,OAAL,CAAaC,EAAb,EAAiBnC,QAAjB;AACA,SAAKkC,OAAL,CAAaC,EAAb,EAAiBlC,CAAC,CAACgC,SAAnB;AACA,UAAMW,EAAE,GAAGnD,MAAM,CAAC+B,KAAP,CAAa,EAAb,CAAX;AAEA,WAAO;AAAEW,MAAAA,EAAF;AAAMlC,MAAAA,CAAN;AAASC,MAAAA,EAAT;AAAa0C,MAAAA,EAAb;AAAiBzC,MAAAA;AAAjB,KAAP;AACD;;AAnJuC","sourcesContent":["import {Buffer} from \"buffer\";\nimport {CipherState, HandshakeState, MessageBuffer, NoiseSession} from \"../@types/handshake\";\nimport {bytes, bytes32} from \"../@types/basic\";\nimport {generateKeypair, isValidPublicKey} from \"../utils\";\nimport {AbstractHandshake} from \"./abstract-handshake\";\nimport {KeyPair} from \"../@types/libp2p\";\n\n\nexport class IK extends AbstractHandshake {\n  public initSession(initiator: boolean, prologue: bytes32, s: KeyPair, rs: bytes32): NoiseSession {\n    const psk = this.createEmptyKey();\n\n    let hs;\n    if (initiator) {\n      hs = this.initializeInitiator(prologue, s, rs, psk);\n    } else {\n      hs = this.initializeResponder(prologue, s, rs, psk);\n    }\n\n    return {\n      hs,\n      i: initiator,\n      mc: 0,\n    };\n  }\n\n  public sendMessage(session: NoiseSession, message: bytes): MessageBuffer {\n    let messageBuffer: MessageBuffer;\n    if (session.mc === 0) {\n      messageBuffer = this.writeMessageA(session.hs, message);\n    } else if (session.mc === 1) {\n      const { messageBuffer: mb, h, cs1, cs2 } = this.writeMessageB(session.hs, message);\n      messageBuffer = mb;\n      session.h = h;\n      session.cs1 = cs1;\n      session.cs2 = cs2;\n    } else if (session.mc > 1) {\n      if (session.i) {\n        if (!session.cs1) {\n          throw new Error(\"CS1 (cipher state) is not defined\")\n        }\n\n        messageBuffer = this.writeMessageRegular(session.cs1, message);\n      } else {\n        if (!session.cs2) {\n          throw new Error(\"CS2 (cipher state) is not defined\")\n        }\n\n        messageBuffer = this.writeMessageRegular(session.cs2, message);\n      }\n    } else {\n      throw new Error(\"Session invalid.\")\n    }\n\n    session.mc++;\n    return messageBuffer;\n  }\n\n  public recvMessage(session: NoiseSession, message: MessageBuffer): {plaintext: bytes; valid: boolean} {\n    let plaintext = Buffer.alloc(0), valid = false;\n    if (session.mc === 0) {\n      ({plaintext, valid} = this.readMessageA(session.hs, message));\n    }\n    if (session.mc === 1) {\n      const { plaintext: pt, valid: v, h, cs1, cs2 } = this.readMessageB(session.hs, message);\n      plaintext = pt;\n      valid = v;\n      session.h = h;\n      session.cs1 = cs1;\n      session.cs2 = cs2;\n    }\n    session.mc++;\n    return {plaintext, valid};\n  }\n\n  private writeMessageA(hs: HandshakeState, payload: bytes): MessageBuffer {\n    hs.e = generateKeypair();\n    const ne = hs.e.publicKey;\n    this.mixHash(hs.ss, ne);\n    this.mixKey(hs.ss, this.dh(hs.e.privateKey, hs.rs));\n    const spk = Buffer.from(hs.s.publicKey);\n    const ns = this.encryptAndHash(hs.ss, spk);\n\n    this.mixKey(hs.ss, this.dh(hs.s.privateKey, hs.rs));\n    const ciphertext = this.encryptAndHash(hs.ss, payload);\n\n    return { ne, ns, ciphertext };\n  }\n\n  private writeMessageB(hs: HandshakeState, payload: bytes) {\n    hs.e = generateKeypair();\n    const ne = hs.e.publicKey;\n    this.mixHash(hs.ss, ne);\n\n    this.mixKey(hs.ss, this.dh(hs.e.privateKey, hs.re));\n    this.mixKey(hs.ss, this.dh(hs.e.privateKey, hs.rs));\n    const ciphertext = this.encryptAndHash(hs.ss, payload);\n    const ns = this.createEmptyKey();\n    const messageBuffer: MessageBuffer = {ne, ns, ciphertext};\n    const { cs1, cs2 } = this.split(hs.ss);\n\n    return { messageBuffer, cs1, cs2, h: hs.ss.h }\n  }\n\n  private readMessageA(hs: HandshakeState, message: MessageBuffer): {plaintext: bytes; valid: boolean} {\n    if (isValidPublicKey(message.ne)) {\n      hs.re = message.ne;\n    }\n\n    this.mixHash(hs.ss, hs.re);\n    this.mixKey(hs.ss, this.dh(hs.s.privateKey, hs.re));\n    const {plaintext: ns, valid: valid1} = this.decryptAndHash(hs.ss, message.ns);\n    if (valid1 && ns.length === 32 && isValidPublicKey(ns)) {\n      hs.rs = ns;\n    }\n    this.mixKey(hs.ss, this.dh(hs.s.privateKey, hs.rs));\n    const {plaintext, valid: valid2} = this.decryptAndHash(hs.ss, message.ciphertext);\n    return {plaintext, valid: (valid1 && valid2)};\n  }\n\n  private readMessageB(hs: HandshakeState, message: MessageBuffer): {h: bytes; plaintext: bytes; valid: boolean; cs1: CipherState; cs2: CipherState} {\n    if (isValidPublicKey(message.ne)) {\n      hs.re = message.ne;\n    }\n\n    this.mixHash(hs.ss, hs.re);\n    if (!hs.e) {\n      throw new Error(\"Handshake state should contain ephemeral key by now.\");\n    }\n    this.mixKey(hs.ss, this.dh(hs.e.privateKey, hs.re));\n    this.mixKey(hs.ss, this.dh(hs.s.privateKey, hs.re));\n    const {plaintext, valid} = this.decryptAndHash(hs.ss, message.ciphertext);\n    const { cs1, cs2 } = this.split(hs.ss);\n\n    return { h: hs.ss.h, valid, plaintext, cs1, cs2 };\n  }\n\n  private initializeInitiator(prologue: bytes32, s: KeyPair, rs: bytes32, psk: bytes32): HandshakeState {\n    const name = \"Noise_IK_25519_ChaChaPoly_SHA256\";\n    const ss = this.initializeSymmetric(name);\n    this.mixHash(ss, prologue);\n    this.mixHash(ss, rs);\n    const re = Buffer.alloc(32);\n\n    return { ss, s, rs, re, psk };\n  }\n\n  private initializeResponder(prologue: bytes32, s: KeyPair, rs: bytes32, psk: bytes32): HandshakeState {\n    const name = \"Noise_IK_25519_ChaChaPoly_SHA256\";\n    const ss = this.initializeSymmetric(name);\n    this.mixHash(ss, prologue);\n    this.mixHash(ss, s.publicKey);\n    const re = Buffer.alloc(32);\n\n    return { ss, s, rs, re, psk };\n  }\n}\n"],"file":"ik.js"}