{"version":3,"sources":["../../src/handshakes/abstract-handshake.ts"],"names":["Buffer","AEAD","x25519","SHA256","getHkdf","logger","MIN_NONCE","AbstractHandshake","encryptWithAd","cs","ad","plaintext","e","encrypt","k","n","setNonce","incrementNonce","decryptWithAd","ciphertext","valid","decrypt","hasKey","isEmptyKey","nonce","createEmptyKey","alloc","emptyKey","equals","nonceToBytes","writeUInt32LE","ctx","from","init","aad","concat","final","encryptAndHash","ss","h","mixHash","tag","slice","length","verify","decryptAndHash","dh","privateKey","publicKey","derived","derive","result","copy","message","data","getHash","a","b","digest","mixKey","ikm","ck","tempK","initializeKey","initializeSymmetric","protocolName","protocolNameBytes","hashProtocolName","key","split","tempk1","tempk2","cs1","cs2","writeMessageRegular","payload","ne","ns","readMessageRegular"],"mappings":"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","sourcesContent":["import {Buffer} from \"buffer\";\nimport AEAD from 'bcrypto/lib/js/aead';\nimport x25519 from 'bcrypto/lib/js/x25519';\nimport SHA256 from 'bcrypto/lib/js/sha256';\n\nimport {bytes, bytes32, uint32} from \"../@types/basic\";\nimport {CipherState, MessageBuffer, SymmetricState} from \"../@types/handshake\";\nimport {getHkdf} from \"../utils\";\nimport {logger} from \"../logger\";\n\nexport const MIN_NONCE = 0;\n\nexport abstract class AbstractHandshake {\n  public encryptWithAd(cs: CipherState, ad: bytes, plaintext: bytes): bytes {\n    const e = this.encrypt(cs.k, cs.n, ad, plaintext);\n    this.setNonce(cs, this.incrementNonce(cs.n));\n\n    return e;\n  }\n\n  public decryptWithAd(cs: CipherState, ad: bytes, ciphertext: bytes): {plaintext: bytes; valid: boolean} {\n    const {plaintext, valid} = this.decrypt(cs.k, cs.n, ad, ciphertext);\n    this.setNonce(cs, this.incrementNonce(cs.n));\n\n    return {plaintext, valid};\n  }\n\n\n  // Cipher state related\n  protected hasKey(cs: CipherState): boolean {\n    return !this.isEmptyKey(cs.k);\n  }\n\n  protected setNonce(cs: CipherState, nonce: uint32): void {\n    cs.n = nonce;\n  }\n\n  protected createEmptyKey(): bytes32 {\n    return Buffer.alloc(32);\n  }\n\n  protected isEmptyKey(k: bytes32): boolean {\n    const emptyKey = this.createEmptyKey();\n    return emptyKey.equals(k);\n  }\n\n  protected incrementNonce(n: uint32): uint32 {\n    return n + 1;\n  }\n\n  protected nonceToBytes(n: uint32): bytes {\n    const nonce = Buffer.alloc(12);\n    nonce.writeUInt32LE(n, 4);\n\n    return nonce;\n  }\n\n  protected encrypt(k: bytes32, n: uint32, ad: bytes, plaintext: bytes): bytes {\n    const nonce = this.nonceToBytes(n);\n    const ctx = new AEAD();\n    plaintext = Buffer.from(plaintext);\n    ctx.init(k, nonce);\n    ctx.aad(ad);\n    ctx.encrypt(plaintext);\n\n    // Encryption is done on the sent reference\n    return Buffer.concat([plaintext, ctx.final()]);\n  }\n\n  protected encryptAndHash(ss: SymmetricState, plaintext: bytes): bytes {\n    let ciphertext;\n    if (this.hasKey(ss.cs)) {\n      ciphertext = this.encryptWithAd(ss.cs, ss.h, plaintext);\n    } else {\n      ciphertext = plaintext;\n    }\n\n    this.mixHash(ss, ciphertext);\n    return ciphertext;\n  }\n\n  protected decrypt(k: bytes32, n: uint32, ad: bytes, ciphertext: bytes): {plaintext: bytes; valid: boolean} {\n    const nonce = this.nonceToBytes(n);\n    const ctx = new AEAD();\n    ciphertext = Buffer.from(ciphertext);\n    const tag = ciphertext.slice(ciphertext.length - 16);\n    ciphertext = ciphertext.slice(0, ciphertext.length - 16);\n    ctx.init(k, nonce);\n    ctx.aad(ad);\n    ctx.decrypt(ciphertext);\n    // Decryption is done on the sent reference\n    return {plaintext: ciphertext, valid: ctx.verify(tag)};\n  }\n\n  protected decryptAndHash(ss: SymmetricState, ciphertext: bytes): {plaintext: bytes; valid: boolean} {\n    let plaintext: bytes, valid = true;\n    if (this.hasKey(ss.cs)) {\n      ({plaintext, valid} = this.decryptWithAd(ss.cs, ss.h, ciphertext));\n    } else {\n      plaintext = ciphertext;\n    }\n\n    this.mixHash(ss, ciphertext);\n    return {plaintext, valid};\n  }\n\n  protected dh(privateKey: bytes32, publicKey: bytes32): bytes32 {\n    try {\n      const derived = x25519.derive(publicKey, privateKey);\n      const result = Buffer.alloc(32);\n      derived.copy(result);\n      return result;\n    } catch (e) {\n      logger(e.message);\n      return Buffer.alloc(32);\n    }\n  }\n\n  protected mixHash(ss: SymmetricState, data: bytes): void {\n    ss.h = this.getHash(ss.h, data);\n  }\n\n  protected getHash(a: bytes, b: bytes): bytes32 {\n    return SHA256.digest(Buffer.from([...a, ...b]));\n  }\n\n  protected mixKey(ss: SymmetricState, ikm: bytes32): void {\n    const [ ck, tempK ] = getHkdf(ss.ck, ikm);\n    ss.cs = this.initializeKey(tempK) as CipherState;\n    ss.ck = ck;\n  }\n\n  protected initializeKey(k: bytes32): CipherState {\n    const n = MIN_NONCE;\n    return { k, n };\n  }\n\n  // Symmetric state related\n\n  protected initializeSymmetric(protocolName: string): SymmetricState {\n    const protocolNameBytes: bytes = Buffer.from(protocolName, 'utf-8');\n    const h = this.hashProtocolName(protocolNameBytes);\n\n    const ck = h;\n    const key = this.createEmptyKey();\n    const cs: CipherState = this.initializeKey(key);\n\n    return { cs, ck, h };\n  }\n\n  protected hashProtocolName(protocolName: bytes): bytes32 {\n    if (protocolName.length <= 32) {\n      const h = Buffer.alloc(32);\n      protocolName.copy(h);\n      return h;\n    } else {\n      return this.getHash(protocolName, Buffer.alloc(0));\n    }\n  }\n\n  protected split(ss: SymmetricState) {\n    const [ tempk1, tempk2 ] = getHkdf(ss.ck, Buffer.alloc(0));\n    const cs1 = this.initializeKey(tempk1);\n    const cs2 = this.initializeKey(tempk2);\n\n    return { cs1, cs2 };\n  }\n\n  protected writeMessageRegular(cs: CipherState, payload: bytes): MessageBuffer {\n    const ciphertext = this.encryptWithAd(cs, Buffer.alloc(0), payload);\n    const ne = this.createEmptyKey();\n    const ns = Buffer.alloc(0);\n\n    return { ne, ns, ciphertext };\n  }\n\n  protected readMessageRegular(cs: CipherState, message: MessageBuffer): {plaintext: bytes; valid: boolean} {\n    return this.decryptWithAd(cs, Buffer.alloc(0), message.ciphertext);\n  }\n}\n"],"file":"abstract-handshake.js"}